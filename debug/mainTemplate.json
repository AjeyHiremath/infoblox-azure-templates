{
    "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
        "vmName":{
            "type":"string",
            "defaultValue":"CSR",
            "metadata":{
                "description":"Name for the Virtual Machine."
            }
        },
        "vmSize":{
            "type":"string",
            "defaultValue":"Standard_DS2",
            "metadata":{
                "description":"Size of the VM"
            }
        },
        "adminPassword":{
            "type":"securestring",
            "defaultValue":"",
            "metadata":{
                "description":"Password for the Virtual Machine."
            }
        },
        "sshPublicKey":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"SSH Key for the virtual machines"
            }
        },
        "authenticationType":{
            "type":"string",
            "defaultValue":"password",
            "allowedValues":[
                "password",
                "sshPublicKey"
            ],
            "metadata":{
                "description":"Authentication Type to chose for the Virtual Machines"
            }
        },
        "virtualNetworkName":{
            "type":"string",
            "defaultValue":"CSR_Network",
            "metadata":{
                "description":"VNet name"
            }
        },
        "virtualNetworkExistingRGName":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Resource Group containing existing network"
            }
        },
        "virtualNetworkAddressPrefix":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Virtual Network Address prefix"
            }
        },
        "vnetNewOrExisting":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Identifies whether to use new or existing Virtual Network"
            }
        },
        "Subnet1Name":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Subnet 1 Name"
            }
        },
        "Subnet1Prefix":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Subnet 1 Prefix"
            }
        },
        "subnet1StartAddress":{
            "type":"string",
            "metadata":{
                "description":"Subnet 1 Starting IP Address"
            }
        },
        "Subnet2Name":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Subnet 2 Name"
            }
        },
        "Subnet2Prefix":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Subnet 2 Prefix"
            }
        },
        "subnet2StartAddress":{
            "type":"string",
            "metadata":{
                "description":"Subnet 2 Starting IP Address"
            }
        },
        "newStorageAccountName":{
            "type":"string",
            "metadata":{
                "description":"Unique Name for Storage Account where the Virtual Machine's disks will be placed."
            }
        },
        "storageAccountType":{
            "type":"string",
            "defaultValue":"Premium_LRS",
            "allowedValues":[
                "Premium_LRS"
            ],
            "metadata":{
                "description":"The type of storage account created."
            }
        },
        "storageAccountNewOrExisting":{
            "type":"string",
            "defaultValue":"new",
            "allowedValues":[
                "new",
                "existing"
            ],
            "metadata":{
                "description":"Identifies whether to use new or existing Storage Account"
            }
        },
        "storageAccountExistingRG":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Resource Group containing existing storage account"
            }
        },
        "newStorageAccountForLogsName":{
            "type":"string",
            "metadata":{
                "description":"Unique Name for Storage Account where the Virtual Machine's boot diagnostics will be placed."
            }
        },
        "storageAccountForLogsType":{
            "type":"string",
            "defaultValue":"Standard_LRS",
            "allowedValues":[
                "Standard_LRS"
            ],
            "metadata":{
                "description":"The type of storage account created for boot diagnostics."
            }
        },
        "storageAccountForLogsNewOrExisting":{
            "type":"string",
            "defaultValue":"new",
            "allowedValues":[
                "new",
                "existing"
            ],
            "metadata":{
                "description":"Identifies whether to use new or existing Storage Account for boot diagnostics"
            }
        },
        "storageAccountForLogsExistingRG":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Resource Group containing existing storage account for boot diagnostics"
            }
        },
        "publicIPAddressName":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Name of the Public IP Address"
            }
        },
        "publicIPDnsName":{
            "type":"string",
            "defaultValue":"csrdns",
            "metadata":{
                "description":"Unique DNS Prefix for the Public IP used to access the Virtual Machine."
            }
        },
        "publicIPNewOrExistingOrNone":{
            "type":"string",
            "defaultValue":"new",
            "allowedValues":[
                "new",
                "existing",
                "none"
            ],
            "metadata":{
                "description":"Indicates whether the Public IP is new or existing"
            }
        },
        "publicIPExistingRGName":{
            "type":"string",
            "defaultValue":"",
            "metadata":{
                "description":"Resource Group containing existing public IP"
            }
        }
    },
    "variables":{
        "templateBaseUrl": "https://raw.githubusercontent.com/ibekleiner/infoblox-azure-templates/master/debug",
        "imagePublisher":"Canonical",
        "imageOffer":"UbuntuServer",
        "imageSKU":"14.04.3-LTS",
        "OSDiskName":"[parameters('vmName')]",
        "vmStorageAccountContainerName":"disks",
        "vnetID":"[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "subnet1Ref":"[concat(variables('vnetID'),'/subnets/', parameters('Subnet1Name'))]",
        "subnet2Ref":"[concat(variables('vnetID'),'/subnets/', parameters('Subnet2Name'))]",
        "nicPrimaryName": "[concat(parameters('vmName'),'-lan1')]",
        "nicSecondaryName": "[concat(parameters('vmName'),'-mgmt')]",
        "apiVer":"2016-06-01",
        "publicIPAddressType":"Dynamic",
        "adminUsername":"azureuser",
        "sshKeyPath":"[concat('/home/',variables('adminUsername'),'/.ssh/authorized_keys')]",
        "storageAccountSetupURL":"[concat(variables('templateBaseUrl'),'/storageAccount-',parameters('storageAccountNewOrExisting'),'.json')]",
        "storageAccountForLogsSetupURL":"[concat(variables('templateBaseUrl'),'/storageAccount-',parameters('storageAccountForLogsNewOrExisting'),'.json')]",
        "publicIPSetupURL":"[concat(variables('templateBaseUrl'),'/publicip-',parameters('publicIPNewOrExistingOrNone'),'.json')]",
        "virtualNetworkSetupURL":"[concat(variables('templateBaseUrl'),'/vnet-',parameters('vnetNewOrExisting'),'.json')]",

        "osProfile":"[variables(concat('osprofile',parameters('authenticationType')))]",
        "osProfilesshPublicKey":{
            "computerName":"[parameters('vmName')]",
            "adminUsername":"[variables('adminUsername')]",
            "linuxConfiguration":{
                "disablePasswordAuthentication":"true",
                "ssh":{
                    "publicKeys":[
                        {
                            "path":"[variables('sshKeyPath')]",
                            "keyData":"[parameters('sshPublicKey')]"
                        }
                    ]
                }
            }
        },
        "osProfilepassword":{
            "computerName":"[parameters('vmName')]",
            "adminUsername":"[variables('adminUsername')]",
            "adminPassword":"[parameters('adminPassword')]"
        }
    },
    "resources":[
        {
            "name":"SettingUpStorageAccount",
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"[variables('apiVer')]",
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"[variables('storageAccountSetupURL')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                    "storageAccountType":{
                        "value":"[parameters('storageAccountType')]"
                    },
                    "storageAccountName":{
                        "value":"[parameters('newStorageAccountName')]"
                    },
                    "storageAccountExistingRG":{
                        "value":"[parameters('storageAccountExistingRG')]"
                    }
                }
            }
        },
        {
            "name":"SettingUpStorageAccountForLogs",
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"[variables('apiVer')]",
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"[variables('storageAccountForLogsSetupURL')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                    "storageAccountType":{
                        "value":"[parameters('storageAccountForLogsType')]"
                    },
                    "storageAccountName":{
                        "value":"[parameters('newStorageAccountForLogsName')]"
                    },
                    "storageAccountExistingRG":{
                        "value":"[parameters('storageAccountForLogsExistingRG')]"
                    }
                }
            }
        },
        {
            "name":"SettingUpVirtualNetwork",
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"[variables('apiVer')]",
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"[variables('virtualNetworkSetupURL')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                    "virtualNetworkName":{
                        "value":"[parameters('virtualNetworkName')]"
                    },
                    "virtualNetworkAddressPrefix":{
                        "value":"[parameters('virtualNetworkAddressPrefix')]"
                    },
                    "Subnet1Name":{
                        "value":"[parameters('Subnet1Name')]"
                    },
                    "Subnet1Prefix":{
                        "value":"[parameters('Subnet1Prefix')]"
                    },
                    "Subnet2Name":{
                        "value":"[parameters('Subnet2Name')]"
                    },
                    "Subnet2Prefix":{
                        "value":"[parameters('Subnet2Prefix')]"
                    },
                    "vnetExistingRGName":{
                        "value":"[parameters('virtualNetworkExistingRGName')]"
                    }
                }
            }
        },
        {
            "apiVersion":"[variables('apiVer')]",
            "type":"Microsoft.Network/networkInterfaces",
            "name":"[variables('nicPrimaryName')]",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[concat('Microsoft.Resources/deployments/', 'SettingUpVirtualNetwork')]"
            ],
            "properties":{
                "ipConfigurations":[
                    {
                        "name":"ipconfig1",
                        "properties":{
                            "privateIPAllocationMethod":"Dynamic",
                            "subnet":{
                                "id":"[reference('Microsoft.Resources/deployments/SettingUpVirtualNetwork',variables('apiVer')).outputs.subnet1Ref.value]"
                            }
                        }
                    }
                ],
                "enableIPForwarding":true
            }
        },
        {
            "apiVersion":"[variables('apiVer')]",
            "type":"Microsoft.Network/networkInterfaces",
            "name":"[variables('nicSecondaryName')]",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[concat('Microsoft.Resources/deployments/', 'SettingUpVirtualNetwork')]"
            ],
            "properties":{
                "ipConfigurations":[
                    {
                        "name":"ipconfig1",
                        "properties":{
                            "privateIPAllocationMethod":"Dynamic",
                            "subnet":{
                                "id":"[reference('Microsoft.Resources/deployments/SettingUpVirtualNetwork',variables('apiVer')).outputs.subnet2Ref.value]"
                            }
                        }
                    }
                ],
                "enableIPForwarding":true
            }
        },
        {
            "name":"SettingUpPublicIP",
            "type":"Microsoft.Resources/deployments",
            "apiVersion":"[variables('apiVer')]",
            "properties":{
                "mode":"Incremental",
                "templateLink":{
                    "uri":"[variables('publicIPSetupURL')]",
                    "contentVersion":"1.0.0.0"
                },
                "parameters":{
                    "publicIPAddressName":{
                        "value":"[parameters('publicIPAddressName')]"
                    },
                    "publicIPAddressType":{
                        "value":"[variables('publicIPAddressType')]"
                    },
                    "dnsPrefix":{
                        "value":"[parameters('publicIPDnsName')]"
                    },
                    "publicIpRGName":{
                        "value":"[parameters('publicIPExistingRGName')]"
                    }
                }
            }
        },
        {
            "apiVersion":"2016-03-30",
            "type":"Microsoft.Compute/virtualMachines",
            "name":"[parameters('vmName')]",
            "location":"[resourceGroup().location]",
            "dependsOn":[
                "[concat('Microsoft.Resources/deployments/', 'SettingUpStorageAccount')]",
                "[concat('Microsoft.Resources/deployments/', 'SettingUpStorageAccountForLogs')]",
                "[concat('Microsoft.Network/networkInterfaces/',variables('nicPrimaryName'))]",
                "[concat('Microsoft.Network/networkInterfaces/',variables('nicSecondaryName'))]"
            ],
            "properties":{
                "hardwareProfile":{
                    "vmSize":"[parameters('vmSize')]"
                },
                "osProfile":"[variables('osProfile')]",
                "storageProfile":{
                    "imageReference":{
                        "publisher":"[variables('imagePublisher')]",
                        "offer":"[variables('imageOffer')]",
                        "sku":"[variables('imageSKU')]",
                        "version":"latest"
                    },
                    "osDisk":{
                        "name":"[variables('OSDiskName')]",
                        "vhd":{
                            "uri":"[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/', variables('vmStorageAccountContainerName'), '/', variables('OSDiskName'), '.vhd')]"
                        },
                        "caching":"ReadWrite",
                        "createOption":"FromImage"
                    }
                },
                "networkProfile":{
                    "networkInterfaces":[
                        {
                            "id":"[resourceId('Microsoft.Network/networkInterfaces/', variables('nicPrimaryName'))]",
                            "properties":{ "primary":true }
                        },
                        {
                            "id":"[resourceId('Microsoft.Network/networkInterfaces/', variables('nicSecondaryName'))]",
                            "properties":{ "primary":false }
                        }
                    ]
                },
                "diagnosticsProfile":{
                    "bootDiagnostics":{
                        "enabled":"false"
                    }
                }
            }
        }
    ]
}